---
epic: 2
story: 6
title: "Infinite Loop & State Sync"
status: "Draft"
---

### Story Statement

As a user, I want to be able to scroll endlessly through the menu categories, and have the top navigator update as I scroll, so that the browsing experience feels seamless and I always know where I am.

### Acceptance Criteria

1.  As the user scrolls vertically through dishes in the `ReelView`, when they pass the last dish of a category, the next dish loaded is the first dish of the subsequent category.
2.  After the last dish of the final category, the loop continues seamlessly to the first dish of the very first category.
3.  As the user scrolls, the `ReelCategoryNavigator` at the top must update in real-time to highlight the category of the dish currently in the viewport.
4.  The scroll position of the top `ReelCategoryNavigator` must also update, keeping the active category centered.

### Dev Notes

#### Technical Specifications

*   **Scroll-to-Item:** The `ReelView` will need to be implemented using a virtualized scrolling library (e.g., `react-virtuoso` or similar) or careful manual implementation to handle a potentially large number of dishes efficiently. Each dish slide should have a unique ID.
*   **State Sync:** The core of this story is state synchronization. The `ReelView` component will need to track the index of the currently visible dish.
*   **Intersection Observer:** The `IntersectionObserver` API is the ideal tool to detect which dish is currently in the viewport. As the user scrolls, this observer will fire events that can be used to update the current dish index in the state.
*   **Logic:** When the current dish index changes, the component will:
    1.  Find the category that the new dish belongs to.
    2.  Update the `activeIndex` prop passed to the `ReelCategoryNavigator`.
*   **Infinite Loop:** The "infinite" loop can be achieved by manipulating the dish list. When approaching the end, prepend items from the beginning, and when approaching the beginning, append items from the end, then silently adjust the scroll position.

#### File Locations

*   This story will heavily modify:
    *   `apps/client/src/components/features/reel/ReelView.tsx`
    *   `apps/client/src/components/features/reel/ReelCategoryNavigator.tsx`

### Tasks / Subtasks

1.  **(AC: 1, 2, 3)** In `ReelView.tsx`, implement the `IntersectionObserver` to track the currently visible dish.
2.  **(AC: 3)** When the visible dish changes, update a state variable holding the current dish's category.
3.  **(AC: 3, 4)** Pass this active category state down to the `ReelCategoryNavigator` component, which will use it to highlight the correct category name.
4.  **(AC: 1, 2)** Implement the infinite scroll logic. When the user gets close to the end of the list, append the first few items to the end. When they scroll near the beginning, prepend the last few items to the start. This gives the illusion of an endless loop.
5.  **Refactor:** This may require refactoring how dishes are rendered in `ReelView` to support the infinite loop (e.g., using a sliding window of rendered components).
6.  **Test (Integration):** This is difficult to test with unit tests. A manual test plan is required. An E2E test with Playwright would be ideal in the future to simulate scrolling and assert that the top navigator updates correctly.
