# Story 2.2: Define and Apply Database Schema

## Status
Approved

## Story
**As a** system,
**I need** the database tables for vendor data to be created,
**so that** data can be stored in a structured way.

## Acceptance Criteria
1. SQL scripts are written for `brand`, `dishes`, and `status` tables.
2. The schema is consistent with the original GSheets structure.
3. Scripts are applied to all subsidiary vendor Supabase projects.
4. Row Level Security (RLS) is enabled on all tables to ensure data isolation.

## Tasks / Subtasks
- [ ] **Task 1 (AC: 1, 2):** Create a new SQL migration file for the vendor schema.
  - [ ] **Subtask 1.1:** In the `supabase/migrations/` directory, create a new migration file (e.g., `0002_create_vendor_tables.sql`).
  - [ ] **Subtask 1.2:** Add the `CREATE TABLE` SQL statements for the `brand`, `dishes`, and `status` tables to the migration file, as defined in `docs/architecture/9-database-schema.md`.
- [ ] **Task 2 (AC: 4):** Implement Row Level Security policies for the new tables.
  - [ ] **Subtask 2.1:** In the same migration file, add the SQL statements to enable RLS on the `brand`, `dishes`, and `status` tables.
  - [ ] **Subtask 2.2:** Add the `CREATE POLICY` statements for each table to ensure a vendor can only access their own data. Use the examples in `docs/architecture/11-backend-architecture.md` as a guide.
- [ ] **Task 3 (AC: 3):** Apply the schema to all vendor-specific Supabase projects.
  - [ ] **Subtask 3.1:** Manually apply the new migration script to each of the subsidiary vendor Supabase projects.

## Dev Notes

### Dev Agent Record

*   **File List**:
    *   `supabase/migrations/0002_create_vendor_tables.sql` (created)

### Dev Notes

#### Database Schema
*   The exact SQL schema for the `brand`, `dishes`, and `status` tables, including `ENUM` types, is defined in the architecture documentation. You must use these definitions.
    *   **[Source: `docs/architecture/9-database-schema.md`]**

#### Backend Architecture & Security
*   This story is critical for establishing our multi-tenant security model. Authorization is enforced using Postgres Row-Level Security (RLS) policies. You must implement RLS for all new tables.
*   The architecture document provides a clear example of how to create RLS policies for the `dishes` table. Apply the same pattern to the `brand` and `status` tables.
    *   **[Source: `docs/architecture/11-backend-architecture.md`]**

#### Project Structure
*   All new database migrations must be created within the `supabase/migrations/` directory. This ensures our schema changes are version-controlled.
    *   **[Source: `docs/architecture/12-unified-project-structure.md`]**

### Testing
*   **Manual Verification:** After applying the migrations, the developer must connect to each subsidiary Supabase project and verify that the `brand`, `dishes`, and `status` tables have been created correctly and that RLS is enabled on each.
*   **Verification Script:** Write a simple script that uses the Supabase client to query the tables as an anonymous user. The query should return no data, proving that RLS is working correctly.

## Change Log
| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| 2025-10-22 | 1.0 | Initial draft created. | Bob (Scrum Master) |
