---
epic: 4
story: 3
title: "Basic Offline Fallback"
status: "Draft"
---

### Story Statement

As a user with an unreliable connection, if I have visited a menu before, I want to see a static image of the menu when I am offline, so that I still have some usable information instead of a browser error.

### Acceptance Criteria

1.  On the first successful page load, if a `full_menu_pic` URL is present in the brand data, the application saves this image to the browser's persistent storage (e.g., IndexedDB).
2.  When a user revisits the page with no network connectivity, the application detects the offline status.
3.  Instead of a browser error, the page displays the saved static menu image with a message like "You are currently offline. Here is a static version of the menu."

### Dev Notes

#### Technical Specifications

*   **Offline Detection:** Use the `navigator.onLine` property to detect the user's network status.
*   **Persistent Storage:** `IndexedDB` is the most suitable technology for storing the image blob, as `localStorage` is not designed for binary data. A simple library like `idb-keyval` can simplify IndexedDB usage.
*   **Service Worker (Optional but Recommended):** For a more robust offline experience, a service worker could be used to intercept the network request and serve the cached image. However, for this basic implementation, logic within the main page component is sufficient.
*   **Fallback UI:** This enhances the error handling logic from Story 1.2. When the data fetch fails due to a network error, the UI should check for the existence of the cached fallback image before showing a generic error page.

#### File Locations

*   This story will modify:
    *   The main page component: `apps/client/src/app/[vendor_slug]/page.tsx`
    *   The data fetching service: `apps/client/src/services/gsheets.ts` (or a new service for image caching).

### Tasks / Subtasks

1.  **Dependency:** Add a library like `idb-keyval` to simplify IndexedDB operations.
2.  **(AC: 1)** In the main page component, after the initial successful fetch of the `brand` data, check if `brand.full_menu_pic` exists.
3.  **(AC: 1)** If it exists, fetch the image as a blob and save it to IndexedDB using a key that includes the vendor's slug.
4.  **(AC: 2, 3)** In the main page component's data fetching logic, if the initial fetch fails, check `navigator.onLine`. 
5.  **(AC: 2, 3)** If the user is offline, attempt to retrieve the fallback image from IndexedDB.
6.  **(AC: 3)** If the fallback image is found, render a simple UI that displays the image and the offline message, instead of the full menu or the generic error page.
7.  **Test (Manual):** This feature is best tested manually using browser developer tools:
    a. Load a menu page online.
    b. Verify the menu image is saved in IndexedDB.
    c. Switch the browser to "Offline" mode.
    d. Refresh the page and verify that the fallback image and message are displayed.
