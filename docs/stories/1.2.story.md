---
epic: 1
story: 2
title: "Modular & Resilient Data Service (v7)"
status: "Approved"
---

### Story Statement

As a user, I want the application to load quickly and be available even with a poor or no network connection, so that I can always view the menu.

### Acceptance Criteria

1.  **Modular Caching:** `brand`, `dishes`, and `status` data must be stored in three separate local storage entries, each with its own timestamp.
2.  **Configurable TTLs:** The cache revalidation times (Time-To-Live) must be configurable, defaulting to: `brand` (10 minutes), `dishes` (5 minutes), and `status` (2 minutes).
3.  **Stale-While-Revalidate:** For each data type, the service must first return cached data (if available and not expired) for an instant UI load, then trigger a silent background fetch to update the cache.
4.  **Offline UI Logic - Full Experience:** If `brand` and `dishes` data are available from the cache, the full interactive menu must be rendered. The status indicator is displayed only if `status` data is also available.
5.  **Offline UI Logic - Fallback Experience:** If only `brand` data is available from the cache (and `dishes` data is missing/stale), the UI must render the `BrandHeader` and display the `full_menu_pic` as a static fallback.
6.  **Offline UI Logic - Error Page:** In all other scenarios (e.g., `brand` data is missing), a full-page, user-friendly error message must be displayed.
7.  **Alerting:** All critical fetch failures must trigger an alert to the configured Lark webhook.

### Dev Notes

#### Technical Specifications

*   **Data Fetching Service:** A dedicated service layer will be responsible for all data fetching and parsing. [Source: `docs/architecture.md#Section-10`]
*   **API Endpoint:** Data is fetched from a public Google Sheet via a `GET` request to `https://docs.google.com/spreadsheets/d/{SHEET_ID}/gviz/tq?tqx=out:csv&sheet={SHEET_NAME}`. [Source: `docs/architecture.md#Section-5`]
*   **Data Models:** The service will parse CSV data into `Brand` and `Dish` TypeScript interfaces. [Source: `docs/architecture.md#Section-4`]
*   **Caching Strategy:** A Local Storage-based "Stale-While-Revalidate" (SWR) strategy must be implemented. [Source: `docs/architecture.md#Section-15`]
*   **Error Handling:** Critical data fetch failures must send a notification to a pre-configured Lark webhook. [Source: `docs/architecture.md#Section-18`]

#### File Locations

*   **Service:** `apps/client/src/services/gsheets.ts` [Source: `docs/architecture.md#Section-12`]
*   **Types:** `apps/client/src/lib/types.ts` [Source: `docs/architecture.md#Section-12`]

### Tasks / Subtasks

1.  **(AC: 1, 2)** Create the `gsheets.ts` service file.
2.  **(AC: 1, 2)** Implement three separate functions: `getBrandData`, `getDishesData`, and `getStatusData`.
3.  **(AC: 1, 2, 3)** For each function, implement the SWR logic:
    *   Check local storage for a corresponding key (e.g., `yumyum-brand-[sheetId]`).
    *   If data exists and its timestamp is within the TTL, return the cached data immediately.
    *   Trigger a background fetch for fresh data.
    *   If data is stale or doesn't exist, fetch fresh data, update local storage with the new data and a new timestamp.
4.  **(AC: 7)** Integrate with the Lark Webhook API to send an alert if any network fetch fails.
5.  **Test (Unit):** Write unit tests for the caching logic, including TTL expiry and key generation.
6.  **Test (Integration):** Write integration tests that mock `fetch` and `localStorage` to verify the SWR flow and error handling.
