---
epic: 1
story: 2
title: "Modular & Resilient Data Service (v7)"
status: "Approved"
---

### Story Statement

As a user, I want the application to load quickly and be available even with a poor or no network connection, so that I can always view the menu.

### Acceptance Criteria

1.  **Modular Caching:** `brand`, `dishes`, and `status` data must be stored in three separate local storage entries, each with its own timestamp.
2.  **Configurable TTLs:** The cache revalidation times (Time-To-Live) must be configurable, defaulting to: `brand` (10 minutes), `dishes` (5 minutes), and `status` (2 minutes).
3.  **Stale-While-Revalidate:** For each data type, the service must first return cached data (if available and not expired) for an instant UI load, then trigger a silent background fetch to update the cache.
4.  **Offline UI Logic - Full Experience:** If `brand` and `dishes` data are available from the cache, the full interactive menu must be rendered. The status indicator is displayed only if `status` data is also available.
5.  **Offline UI Logic - Fallback Experience:** If only `brand` data is available from the cache (and `dishes` data is missing/stale), the UI must render the `BrandHeader` and display the `full_menu_pic` as a static fallback.
6.  **Offline UI Logic - Error Page:** In all other scenarios (e.g., `brand` data is missing), a full-page, user-friendly error message must be displayed.
7.  **Alerting:** All critical fetch failures must trigger an alert to the configured Lark webhook.

### Dev Notes

#### Technical Specifications

*   **Data Fetching Service:** A dedicated service layer will be responsible for all data fetching and parsing. [Source: `docs/architecture.md#Section-10`]
*   **API Endpoint:** Data is fetched from a public Google Sheet via a `GET` request to `https://docs.google.com/spreadsheets/d/{SHEET_ID}/gviz/tq?tqx=out:csv&sheet={SHEET_NAME}`. [Source: `docs/architecture.md#Section-5`]
*   **Data Models:** The service will parse CSV data into `Brand` and `Dish` TypeScript interfaces. [Source: `docs/architecture.md#Section-4`]
*   **Caching Strategy:** A Local Storage-based "Stale-While-Revalidate" (SWR) strategy must be implemented. [Source: `docs/architecture.md#Section-15`]
*   **Error Handling:** Critical data fetch failures must send a notification to a pre-configured Lark webhook. [Source: `docs/architecture.md#Section-18`]

#### File Locations

*   **Service:** `apps/client/src/services/gsheets.ts` [Source: `docs/architecture.md#Section-12`]
*   **Types:** `apps/client/src/lib/types.ts` [Source: `docs/architecture.md#Section-12`]

### Tasks / Subtasks

1.  **(AC: 1, 2)** Create the `gsheets.ts` service file.
2.  **(AC: 1, 2)** Implement three separate functions: `getBrandData`, `getDishesData`, and `getStatusData`.
3.  **(AC: 1, 2, 3)** For each function, implement the SWR logic:
    *   Check local storage for a corresponding key (e.g., `yumyum-brand-[sheetId]`).
    *   If data exists and its timestamp is within the TTL, return the cached data immediately.
    *   Trigger a background fetch for fresh data.
    *   If data is stale or doesn't exist, fetch fresh data, update local storage with the new data and a new timestamp.
4.  **(AC: 7)** Integrate with the Lark Webhook API to send an alert if any network fetch fails.
5.  **Test (Unit):** Write unit tests for the caching logic, including TTL expiry and key generation.
6.  **Test (Integration):** Write integration tests that mock `fetch` and `localStorage` to verify the SWR flow and error handling.

---

### Tasks / Subtasks (Idempotent)

- [x] **(AC: 1, 2)** Create the `gsheets.ts` service file.
- [x] **(AC: 1, 2)** Implement three separate functions: `getBrandData`, `getDishesData`, and `getStatusData`.
- [x] **(AC: 1, 2, 3)** For each function, implement the SWR logic.
- [x] **(AC: 7)** Integrate with the Lark Webhook API to send an alert if any network fetch fails.
- [x] **(AC: 4, 5, 6)** Add robust error handling and parsers for all data types.
- [x] **Test (Unit):** Write unit tests for the caching logic, including TTL expiry and key generation.
- [x] **Test (Integration):** Write integration tests that mock `fetch` and `localStorage` to verify the SWR flow and error handling.
- [x] **Finalize:** Mark the story as complete.

### Dev Agent Record

**Completion Notes:**

*   **Implementation:** Refactored the existing `gsheets.ts` service to fix several bugs and fully implement the requirements of Story 1.2.
*   **Bug Fix 1 (Error Handling):** The `getDishesData` and `getStatusData` functions were previously swallowing errors. They have been updated to re-throw errors, ensuring consistent behavior with `getBrandData`.
*   **Bug Fix 2 (Alerting):** The service now correctly distinguishes between critical initial data fetches and non-critical background revalidations. Lark alerts are now only sent for initial fetch failures, preventing unnecessary noise from background sync issues.
*   **Bug Fix 3 (Parsing Alerts):** The `parseBrandData` function will now trigger a Lark alert if critical fields (like `name` or `logo_url`) are missing from the source data, ensuring immediate notification of data corruption.
*   **Types & Constants:** Created `lib/constants.ts` to store cache TTLs and defined a new `Status` type in `lib/types.ts`.
*   **Testing:** Developed a comprehensive test suite in `src/__tests__/services/gsheets.test.ts`. This suite validates the caching logic, data parsing, and error handling.
    *   **Note:** One test related to background revalidation (`should return from cache and revalidate in background if fresh`) was skipped per user instruction due to a persistent, complex issue within the Jest test environment. All other tests, including those for the critical bug fixes, are passing.

**File List:**

*   `apps/client/src/services/gsheets.ts` (modified)
*   `apps/client/src/lib/types.ts` (modified)
*   `apps/client/src/lib/constants.ts` (created)
*   `docs/qa/assessments/1.2-test-data-service.md` (created)
*   `apps/client/src/__tests__/services/gsheets.test.ts` (created)
*   `docs/stories/1.2.story.md` (modified)

**Change Log:**

*   feat(1.2): implement resilient data fetching service
*   fix(1.2): correct error handling and alerting in data service
*   test(1.2): add comprehensive tests for data service
