# Story 2.7.1: Refactor Data Fetching to Enforce Supabase-First Rule

## Status

Ready for Dev

## Story

**As a** system,
**I need** to refactor the data fetching logic to strictly adhere to the "Supabase-first" rule,
**so that** the application respects the designated backend for each vendor and ensures data integrity.

## Acceptance Criteria

1.  The `fetchVendorData` function in `src/app/[vendor_slug]/page.tsx` is refactored to:
    a. [x] First, query the `vendor_mappings` table in Supabase using the `vendor_slug`.
    b. [x] If no mapping is found, trigger a `404 Not Found` page.
    c. [x] If a mapping is found, check the `backend_type`.
    d. [x] If `backend_type` is `'supabase'`, all data (`brand`, `dishes`, `status`) **must** be fetched from the corresponding Supabase project.
    e. [x] If `backend_type` is `'gsheets'`, all data **must** be fetched from the corresponding Google Sheet.
2.  The `/api/search-partners` API route is refactored to:
    a. [x] First, query Supabase for vendors matching the search term.
    b. [x] For any remaining search (e.g., for vendors not in Supabase), it **must** only search against vendors explicitly marked with `backend_type: 'gsheets'` in the `vendor_mappings` table.
    c. [x] The final result set must not contain duplicate vendors and must prioritize Supabase data if a vendor were to exist in both places.
3.  [x] The `getSheetIdForSlug` function in `src/services/gsheets.ts` is deprecated or refactored to no longer be the primary method for determining a vendor's data source from the slug.

## Dev Notes

### Context

- This story is a direct result of a compliance check that found violations of the data source rules defined in `docs/architecture/7-external-apis.md`.
- The current implementation incorrectly defaults to Google Sheets for data fetching, which must be corrected.

### Files to Modify

- `src/app/[vendor_slug]/page.tsx`
- `src/app/api/search-partners/route.ts`
- `src/services/gsheets.ts` (potentially for deprecation)
- `src/services/vendor.ts` (a new function to get vendor mapping by slug might be needed)

### Technical Guidance

- A new service function, likely in `src/services/vendor.ts`, should be created to fetch a vendor's complete mapping details from Supabase by their `vendor_slug`. This will be the new starting point for all data fetching on the vendor page.
- The logic must be clean and unambiguous. There should be a clear `if/else` or `switch` statement based on the `backend_type` that directs the data fetching process.

### Testing

- All existing unit and integration tests for the vendor page and search API must be updated to reflect the new logic.
- New tests should be added to specifically verify the `backend_type` branching logic. For example, a test should assert that for a vendor with `backend_type: 'supabase'`, no calls are made to the `gsheets` service.
