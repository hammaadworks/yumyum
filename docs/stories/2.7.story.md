<!-- Powered by BMADâ„¢ Core -->

# Story 2.7: Implement Vendor Membership and Enhanced Authentication

**Status:** Draft

**Story Statement:** As a vendor, I want my membership status to be tracked and my login experience to be secure and personalized, so that I can access my dashboard efficiently and administrators can manage my membership.

**Acceptance Criteria:**
1.  The `vendor_mappings` table in the primary Supabase project is updated to include `membership_fee` (real, default 0), `membership_validity` (date, default current date + 10 days), and `is_member` (boolean, default true).
2.  RLS policies are implemented for the `vendor_mappings` table to ensure vendors can only access their own mapping data.
3.  The login page (`/login`) implements the enhanced magic link authentication flow:
    *   Upon email submission, the system first checks if the email exists in `vendor_mappings`.
    *   If the email is not found, an error message ("This email is not registered with YumYum. Please contact support if you believe this is an error.") is displayed, and no magic link is sent. A "Go Home" button is also displayed.
    *   If the email is found, a magic link is sent via Supabase.
4.  Upon successful authentication via magic link, the user is redirected to `/{vendor-slug}/dashboard`, where `vendor-slug` is retrieved from `vendor_mappings`.
5.  APIs are developed within the YumYum admin panel to update the `is_member` field in the `vendor_mappings` table for a given vendor.
6.  The admin APIs for `is_member` management ensure proper authentication and authorization for admin users.

---

## Dev Notes

### Data Models
*   **`VendorMapping` TypeScript Interface:**
    ```typescript
    export type BackendType = 'supabase' | 'gsheets';

    export interface VendorMapping {
      id: number;
      vendor_slug: string; // e.g., 'the-burger-den'
      backend_type: BackendType; // 'supabase' or 'gsheets'
      supabase_project_id?: string; // Which of the 4 Supabase projects
      gsheet_id?: string;
      imagekit_account_id: string; // Which of the 4 ImageKit accounts
      membership_fee: number;
      membership_validity: string; // ISO 8601 date string
      is_member: boolean;
    }
    ```
    [Source: architecture/4-data-models.md#vendor_mappings]

*   **`public.vendor_mappings` SQL Schema:**
    ```sql
    CREATE TABLE public.vendor_mappings (
      id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
      vendor_slug text NOT NULL UNIQUE,
      backend_type text NOT NULL, -- 'supabase' or 'gsheets'
      supabase_project_id text,
      gsheet_id text,
      imagekit_account_id text NOT NULL,
      membership_fee real DEFAULT 0,
      membership_validity date DEFAULT (now() + '10 days'::interval),
      is_member boolean DEFAULT true,
      created_at timestamp with time zone NOT NULL DEFAULT now()
    );
    ```
    [Source: architecture/9-database-schema.md#public.vendor_mappings]

### API Specifications
*   No specific API endpoints are defined in the architecture for the admin panel `is_member` management, but they should follow REST principles and integrate with Supabase for data persistence.
*   Supabase Auth `signInWithOtp` will be used for magic link generation.
    [Source: architecture/3-tech-stack.md#Authentication]

### Component Specifications
*   The `/login` page will require UI elements to display the error message and a "Go Home" button when an email is not found in `vendor_mappings`.
*   The admin panel will require UI components (forms, buttons) to manage the `is_member` status for vendors.
*   Components should follow `shadcn/ui` pattern, using `React.forwardRef` and `cn` utility.
    [Source: architecture/17-coding-standards.md#Component Structure]

### File Locations
*   Authentication logic should reside in `/src/services` to abstract Supabase client calls.
    [Source: architecture/17-coding-standards.md#Data Fetching]
*   New UI components for login error handling and admin panel membership management should be placed in `/src/components`.
*   Database migration scripts for `vendor_mappings` updates should be managed appropriately (e.g., `supabase/migrations`).

### Testing Requirements
*   **Unit Tests:**
    *   Test the logic for checking email against `vendor_mappings`.
    *   Test the redirection logic after successful login.
    *   Test the admin API functions for updating `is_member`.
    [Source: architecture/16-testing-strategy.md#Unit Tests]
*   **Integration Tests:**
    *   Test the complete login flow, including email verification and redirection.
    *   Test the interaction between the admin UI and the `is_member` update API.
    [Source: architecture/16-testing-strategy.md#Integration Tests]
*   **End-to-End (E2E) Tests:**
    *   Verify a vendor can successfully log in with a registered email and be redirected to their dashboard.
    *   Verify an unregistered email fails to log in and displays the correct error message.
    *   Verify an administrator can update a vendor's `is_member` status via the admin panel.
    [Source: architecture/16-testing-strategy.md#End-to-End (E2E) Tests]

### Technical Constraints
*   All authentication handled by Supabase Auth.
    [Source: architecture/15-security-and-performance.md#Authentication]
*   Environment variables (`.env.local`) must be used for sensitive keys.
*   Type safety must be maintained; `any` is discouraged.
    [Source: architecture/17-coding-standards.md#Type Safety]

### Security Considerations
*   **RLS for `public.vendor_mappings`:** RLS policies must be implemented to restrict vendors to viewing and managing only their own mapping data.
    [Source: architecture/15-security-and-performance.md#Authorization]

---

## Tasks / Subtasks

1.  **Database Schema Update (AC: 1, 2)**
    *   Modify `supabase/migrations` to update the `public.vendor_mappings` table with `membership_fee`, `membership_validity`, and `is_member` columns, including default values.
    *   Implement RLS policies for `public.vendor_mappings` to ensure row-level security based on vendor ownership.
    *   Write unit tests for RLS policies to verify correct access control.
    [Source: architecture/9-database-schema.md, architecture/15-security-and-performance.md]

2.  **Enhanced Magic Link Authentication (AC: 3, 4)**
    *   Update the `/login` page and associated authentication service (`/src/services/auth.ts` or similar) to first query `public.vendor_mappings` with the provided email.
    *   If the email is not found in `vendor_mappings`, display the error message "This email is not registered with YumYum. Please contact support if you believe this is an error." and a "Go Home" button. Do not send a magic link.
    *   If the email is found, proceed with sending the Supabase magic link.
    *   Modify the authentication callback handler to redirect to `/{vendor-slug}/dashboard` upon successful login, dynamically retrieving `vendor-slug` from `vendor_mappings`.
    *   Write unit tests for the email verification logic and redirection.
    *   Write integration tests for the complete login flow.
    *   Write E2E tests for successful and failed login scenarios.
    [Source: architecture/8-core-workflows.md, architecture/16-testing-strategy.md]

3.  **Admin APIs for Membership Management (AC: 5, 6)**
    *   Develop new API endpoints (e.g., within `/src/services/admin.ts` or a Supabase Edge Function) for the YumYum admin panel to update the `is_member` field in `public.vendor_mappings`.
    *   Implement authentication and authorization checks for these admin APIs to ensure only authorized administrators can modify the `is_member` status.
    *   Write unit tests for the admin API logic, including authorization.
    *   Write E2E tests to verify an administrator can successfully update `is_member` status.
    [Source: architecture/17-coding-standards.md#Data Fetching, architecture/16-testing-strategy.md]
