# Story 2.1: Provision and Configure Supabase Projects

## Status
Done

## Story
**As a** developer,
**I need** the Supabase projects set up and a database-driven vendor mapping system in place,
**so that** I can begin backend development.

## Acceptance Criteria
1. A primary Supabase project and a pool of subsidiary vendor accounts are created.
2. API keys are added to environment variables.
3. A `vendor_mappings` table is created in the primary project.
4. The manual vendor allocation process is documented in the wiki.

## Tasks / Subtasks
- [x] **Task 1 (AC: 1):** Manually provision Supabase projects.
  - [x] **Subtask 1.1:** Create one primary Supabase project.
  - [x] **Subtask 1.2:** Create a pool of four subsidiary Supabase projects for vendors.
- [x] **Task 2 (AC: 2):** Configure environment variables.
  - [x] **Subtask 2.1:** Add the API URL and `anon` key for the primary Supabase project to the project's `.env.local` file. The keys are `NEXT_PUBLIC_SUPABASE_ACCT_1_URL` and `NEXT_PUBLIC_SUPABASE_ACCT_1_ANON_KEY` in the `.env.local` file for the  primary account.
- [x] **Task 3 (AC: 3):** Create the `vendor_mappings` table.
  - [x] **Subtask 3.1:** Create a new SQL migration file in `supabase/migrations/`.
  - [x] **Subtask 3.2:** Add the SQL `CREATE TABLE` statement for `vendor_mappings` to the migration file, as defined in `docs/architecture/9-database-schema.md`.
  - [x] **Subtask 3.3:** Apply the migration to the primary Supabase project.
- [x] **Task 4 (AC: 4):** Document the vendor allocation process.
  - [x] **Subtask 4.1:** Create a new page in the project wiki (`/wiki`).
  - [x] **Subtask 4.2:** Document the manual process for allocating a new vendor to one of the subsidiary Supabase projects and updating the `vendor_mappings` table.

## Dev Notes

### Dev Agent Record

*   **File List**:
    *   `supabase/migrations/0001_create_vendor_mappings.sql` (created)
    *   `wiki/vendor-allocation-process.md` (created)

### Dev Notes

#### Previous Story Insights
*   No specific insights from previous frontend stories are applicable here. This story is foundational backend work.

#### Data Models
*   **`vendor_mappings`**: This story introduces the `vendor_mappings` table, which is central to the multi-tenant architecture. The schema is defined in the architecture documents.
    *   **[Source: `docs/architecture/4-data-models.md`]**

#### API Specifications
*   While this story doesn't involve consuming the API, it sets the foundation for future API interactions by configuring the primary Supabase project. All future data access will use the `@supabase/supabase-js` client.
    *   **[Source: `docs/architecture/5-api-specification.md`]**

#### Database Schema
*   The SQL for the `vendor_mappings` table is explicitly defined and should be placed in a migration file.
    *   **[Source: `docs/architecture/9-database-schema.md`]**
    ```sql
    CREATE TABLE public.vendor_mappings (
      id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
      vendor_slug text NOT NULL UNIQUE,
      backend_type text NOT NULL, -- 'supabase' or 'gsheets'
      supabase_project_id text,
      gsheet_id text,
      imagekit_account_id text NOT NULL,
      created_at timestamp with time zone NOT NULL DEFAULT now()
    );
    ```

#### Backend Architecture
*   This story is the first step in implementing the BaaS architecture. The primary Supabase project will serve as the central hub for vendor routing.
    *   **[Source: `docs/architecture/11-backend-architecture.md`]**

#### Project Structure
*   New database migrations must be created within the `supabase/migrations/` directory.
    *   **[Source: `docs/architecture/12-unified-project-structure.md`]**
*   New documentation should be placed in the `/wiki` directory.
    *   **[Source: `docs/architecture/12-unified-project-structure.md`]**

#### External Services
*   This story requires manual setup and configuration of Supabase projects.
    *   **[Source: `docs/architecture/7-external-apis.md`]**

### Testing
*   **Manual Verification:** After applying the migration, the developer must connect to the primary Supabase project and verify that the `vendor_mappings` table has been created with the correct columns.
*   **Environment Variable Test:** Create a temporary test script to load the environment variables and attempt to connect to the primary Supabase project using the Supabase client. This will verify that the keys are correct.

## Change Log
| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| 2025-10-22 | 1.0 | Initial draft created. | Bob (Scrum Master) |
