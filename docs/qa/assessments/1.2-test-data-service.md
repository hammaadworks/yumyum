---
epic: 1
story: 2
title: "Test Design: Modular & Resilient Data Service"
---

### 1. Introduction

This document outlines the test plan for **Story 1.2: Modular & Resilient Data Service**. The goal is to verify that the data fetching service located at `apps/client/src/services/gsheets.ts` correctly implements the specified requirements for caching, data parsing, error handling, and offline support.

### 2. Test Objectives

*   **Verify SWR Caching:** Ensure the "Stale-While-Revalidate" logic is correctly implemented for `brand`, `dishes`, and `status` data.
*   **Validate Data Parsing:** Confirm that raw CSV data from Google Sheets is accurately parsed into the correct TypeScript models (`Brand`, `Dish`, `Status`).
*   **Assess Error Handling:** Test the system's resilience to network failures, parsing errors, and invalid data.
*   **Confirm Alerting:** Ensure critical failures trigger alerts to the configured Lark webhook.
*   **Test Data Isolation:** Verify that data for different vendors (and their corresponding sheet IDs) is cached separately.

### 3. Test Scope

*   **In Scope:**
    *   Unit and integration tests for `gsheets.ts`.
    *   Mocking `fetch` to simulate network requests.
    *   Mocking `localStorage` to test caching behavior.
    *   Testing the helper functions (`parseCSV`, `getSheetIdForSlug`, etc.).
*   **Out of Scope:**
    *   End-to-end testing of the UI components that consume this service.
    *   Actual network calls to Google Sheets or Lark.

### 4. Test Cases

#### 4.1. Caching Logic (`swrFetch`)

| Test Case ID | Description | Steps | Expected Result |
| :--- | :--- | :--- | :--- |
| **1.2-C-01** | **Initial Fetch (Cache Miss):** Request data when the cache is empty. | 1. Mock `localStorage` to be empty. <br> 2. Mock a successful `fetch` response. <br> 3. Call `getBrandData`. | 1. `fetch` is called once. <br> 2. The parsed data is returned. <br> 3. `localStorage` is populated with the data and a timestamp. |
| **1.2-C-02** | **Cache Hit (Fresh):** Request data when a fresh entry is in the cache. | 1. Mock `localStorage` with a recent timestamp. <br> 2. Mock a successful `fetch` response for revalidation. <br> 3. Call `getBrandData`. | 1. The cached data is returned **immediately**. <br> 2. A background `fetch` is triggered to revalidate. |
| **1.2-C-03** | **Cache Hit (Stale):** Request data when a stale entry is in the cache. | 1. Mock `localStorage` with an old timestamp (older than the TTL). <br> 2. Mock a successful `fetch` response. <br> 3. Call `getBrandData`. | 1. `fetch` is called. <br> 2. The new, fetched data is returned. <br> 3. `localStorage` is updated. |
| **1.2-C-04** | **Concurrent Requests:** Make two concurrent requests for the same data. | 1. Mock `localStorage` to be empty. <br> 2. Mock `fetch` to have a delay. <br> 3. Call `getBrandData` twice using `Promise.all`. | 1. `fetch` is called only **once** (in-flight request deduplication). <br> 2. Both calls resolve with the same data. |
| **1.2-C-05** | **Cache Isolation:** Ensure caches for different sheet IDs are separate. | 1. Call `getBrandData` for `sheet-A`. <br> 2. Call `getBrandData` for `sheet-B`. | 1. `fetch` is called for both sheets. <br> 2. Two separate entries (`yumyum-brand-sheet-a`, `yumyum-brand-sheet-b`) exist in `localStorage`. |

#### 4.2. Data Parsing

| Test Case ID | Description | Steps | Expected Result |
| :--- | :--- | :--- | :--- |
| **1.2-P-01** | **Parse Valid Brand Data:** Test `parseBrandData` with a valid CSV grid. | 1. Provide a 2D array representing a valid `brand` sheet. | A correctly structured `Brand` object is returned. |
| **1.2-P-02** | **Parse Brand Data (Missing Required Field):** Test with `name` field missing. | 1. Provide a CSV grid where the `name` column is empty. | `null` is returned and an error is logged. |
| **1.2-P-03** | **Parse Valid Dishes Data:** Test `parseDishesData` with a valid CSV grid. | 1. Provide a 2D array representing a valid `dishes` sheet. | An array of `Dish` objects is returned, with system-generated `id`s. |
| **1.2-P-04** | **Parse Dishes Data (Empty Sheet):** Test with an empty or header-only CSV. | 1. Provide a 1-row (header only) or empty array. | An empty array `[]` is returned. |
| **1.2-P-05** | **Parse Valid Status Data:** Test `parseStatusData` with a valid CSV grid. | 1. Provide a 2D array of strings. | A flattened array of non-empty strings is returned. |

#### 4.3. Error Handling and Alerting

| Test Case ID | Description | Steps | Expected Result |
| :--- | :--- | :--- | :--- |
| **1.2-E-01** | **Network Failure (Initial Fetch):** `fetch` fails on the first attempt. | 1. Mock `fetch` to throw a network error. <br> 2. Mock the Lark webhook endpoint. <br> 3. Call `getBrandData`. | 1. The function throws the error. <br> 2. An alert is sent to the Lark webhook. |
| **1.2-E-02** | **Network Failure (Background Revalidation):** `fetch` fails during a background revalidation. | 1. Mock `localStorage` with a fresh cache entry. <br> 2. Mock `fetch` to throw a network error. <br> 3. Call `getBrandData`. | 1. The cached data is returned successfully. <br> 2. A warning is logged to the console about the failed revalidation. <br> 3. **No Lark alert should be sent** for background failures. |
| **1.2-E-03** | **Slug Resolution Failure:** `getSheetIdForSlug` fails to find a slug. | 1. Mock the admin sheet response. <br> 2. Call `getSheetIdForSlug` with a non-existent slug. | The function returns `null`. |
| **1.2-E-04** | **Slug Resolution Network Failure:** `fetch` for the admin sheet fails. | 1. Mock `fetch` to throw an error. <br> 2. Mock the Lark webhook endpoint. <br> 3. Call `getSheetIdForSlug`. | 1. The function returns `null`. <br> 2. A critical alert is sent to the Lark webhook. |