# Test Design: Story 2.7: Implement Vendor Membership and Enhanced Authentication

Date: 2025-10-28
Designer: Quinn (Test Architect)

## Test Strategy Overview

- Total test scenarios: 13
- Unit tests: 2 (15%)
- Integration tests: 7 (54%)
- E2E tests: 4 (31%)
- Priority distribution: P0: 7, P1: 5, P2: 1

## Test Scenarios by Acceptance Criteria

### AC1: `vendor_mappings` table is updated

| ID           | Level       | Priority | Test                                                                      | Justification                           |
| ------------ | ----------- | -------- | ------------------------------------------------------------------------- | --------------------------------------- |
| 2.7-UNIT-001 | Unit        | P0       | Test the migration script for correct column addition and default values. | Pure logic, ensures schema correctness. |
| 2.7-INT-001  | Integration | P1       | Verify new `vendor_mappings` entries get default values.                  | Interaction with the database.          |

### AC2: RLS policies are implemented

| ID          | Level       | Priority | Test                                                   | Justification                           |
| ----------- | ----------- | -------- | ------------------------------------------------------ | --------------------------------------- |
| 2.7-INT-002 | Integration | P0       | A logged-in vendor can only select their own row.      | Security validation, mitigates SEC-001. |
| 2.7-INT-003 | Integration | P0       | A logged-in vendor cannot select another vendor's row. | Security validation, mitigates SEC-001. |
| 2.7-INT-004 | Integration | P0       | An unauthenticated user cannot select any rows.        | Security validation, mitigates SEC-001. |

### AC3: Enhanced magic link authentication flow

| ID           | Level | Priority | Test                                                                | Justification                         |
| ------------ | ----- | -------- | ------------------------------------------------------------------- | ------------------------------------- |
| 2.7-UNIT-002 | Unit  | P1       | Test the function checking if an email exists in `vendor_mappings`. | Pure logic, core of the new flow.     |
| 2.7-E2E-001  | E2E   | P1       | Unregistered email shows error message and sends no link.           | Critical user journey, negative path. |
| 2.7-E2E-002  | E2E   | P0       | Registered email triggers magic link.                               | Critical user journey, positive path. |

### AC4: Redirection upon successful authentication

| ID          | Level       | Priority | Test                                                          | Justification                                 |
| ----------- | ----------- | -------- | ------------------------------------------------------------- | --------------------------------------------- |
| 2.7-INT-005 | Integration | P1       | Callback handler correctly fetches `vendor-slug`.             | Interaction with DB, mitigates DATA-001.      |
| 2.7-E2E-003 | E2E         | P0       | User is redirected to `/{vendor-slug}/dashboard` after login. | Critical user journey, end-to-end validation. |

### AC5 & AC6: Admin APIs for Membership Management

| ID           | Level       | Priority | Test                                                     | Justification                           |
| ------------ | ----------- | -------- | -------------------------------------------------------- | --------------------------------------- |
| 2.7-UNIT-003 | Unit        | P2       | Test the API function logic for updating `is_member`.    | Pure logic for the update operation.    |
| 2.7-INT-006  | Integration | P1       | Admin API updates `is_member` in the database correctly. | Interaction with the database.          |
| 2.7-INT-007  | Integration | P0       | Unauthenticated request to admin API fails.              | Security validation, mitigates SEC-002. |
| 2.7-INT-008  | Integration | P0       | Non-admin user request to admin API fails.               | Security validation, mitigates SEC-002. |

## Risk Coverage

- **SEC-001 (RLS Bypass):** Covered by `2.7-INT-002`, `2.7-INT-003`, `2.7-INT-004`.
- **SEC-002 (Admin API Auth Failure):** Covered by `2.7-INT-007`, `2.7-INT-008`.
- **DATA-001 (Incorrect Redirection):** Covered by `2.7-INT-005`, `2.7-E2E-003`.

## Recommended Execution Order

1.  P0 Unit and Integration tests.
2.  P0 E2E tests.
3.  P1 tests.
4.  P2 tests.
