# Requirements Traceability Matrix

## Story: 2.7 - Implement Vendor Membership and Enhanced Authentication

### Coverage Summary

- Total Requirements: 6
- Fully Covered: 6 (100%)
- Partially Covered: 0 (0%)
- Not Covered: 0 (0%)

### Requirement Mappings

#### AC1: The `vendor_mappings` table is updated to include `membership_fee`, `membership_validity`, and `is_member`.

**Coverage: FULL**

- **Unit Test**: `2.7-UNIT-001`
  - **Given**: The database schema before the migration.
  - **When**: The migration script is executed.
  - **Then**: The `vendor_mappings` table contains the new columns with correct types and default values.
- **Integration Test**: `2.7-INT-001`
  - **Given**: The migration has been applied.
  - **When**: A new vendor mapping is created without specifying the new fields.
  - **Then**: The database sets the correct default values for `membership_fee`, `membership_validity`, and `is_member`.

#### AC2: RLS policies are implemented for the `vendor_mappings` table.

**Coverage: FULL**

- **Integration Tests**: `2.7-INT-002`, `2.7-INT-003`, `2.7-INT-004`
  - **Given**: Multiple vendor accounts exist in the `vendor_mappings` table.
  - **When**: An authenticated vendor, and then an unauthenticated user, attempt to query the table.
  - **Then**: The authenticated vendor can only retrieve their own data, and the unauthenticated user retrieves nothing.

#### AC3: The login page implements the enhanced magic link authentication flow.

**Coverage: FULL**

- **Unit Test**: `2.7-UNIT-002`
  - **Given**: A function that checks for an email's existence.
  - **When**: The function is called with a registered email and an unregistered email.
  - **Then**: It returns `true` for the registered email and `false` for the unregistered one.
- **E2E Tests**: `2.7-E2E-001`, `2.7-E2E-002`
  - **Given**: A user is on the `/login` page.
  - **When**: They enter a registered email, and then an unregistered email.
  - **Then**: A magic link is sent only for the registered email; an error is shown for the unregistered one.

#### AC4: Upon successful authentication via magic link, the user is redirected to `/{vendor-slug}/dashboard`.

**Coverage: FULL**

- **Integration Test**: `2.7-INT-005`
  - **Given**: A valid magic link for a vendor.
  - **When**: The authentication callback is triggered.
  - **Then**: The handler correctly retrieves the `vendor-slug` from the database.
- **E2E Test**: `2.7-E2E-003`
  - **Given**: A user clicks a valid magic link.
  - **When**: They are authenticated by the system.
  - **Then**: They are redirected to their unique vendor dashboard URL.

#### AC5: APIs are developed to update the `is_member` field.

**Coverage: FULL**

- **Unit Test**: `2.7-UNIT-003`
  - **Given**: The API logic for updating the `is_member` status.
  - **When**: The function is called with a vendor ID and a new boolean value.
  - **Then**: It constructs the correct database update command.
- **Integration Test**: `2.7-INT-006`
  - **Given**: An admin user is authenticated.
  - **When**: The admin API is called to update a vendor's `is_member` status.
  - **Then**: The corresponding record in the `vendor_mappings` table is updated.

#### AC6: The admin APIs for `is_member` management ensure proper authentication and authorization.

**Coverage: FULL**

- **Integration Tests**: `2.7-INT-007`, `2.7-INT-008`
  - **Given**: The admin API endpoint for membership management.
  - **When**: The endpoint is called by an unauthenticated user, a non-admin user, and an admin user.
  - **Then**: The request fails with an error for the first two and succeeds for the admin.

### Critical Gaps

None identified. All acceptance criteria are fully covered by the proposed test design.
